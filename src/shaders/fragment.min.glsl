#version 330 core
in vec4 gl_FragCoord;out vec4 FragColor;const int v=20;const float i=100.;uniform float iTime;uniform vec2 iResolution;uniform vec3 iCamera,iTarget;uniform vec4 iLeipae[v];float y=(i-iTime)/i;const int m=400;const float f=0.,z=100.,r=60.,x=1e-5,e=3.14159265,w=.3;const vec3 c=vec3(.8,1.,1.),s=vec3(.06,.03,.69),k=vec3(.94,.12,.58),g=vec3(2.5,1.5,1.);mat3 n(float v){float i=sin(v),x=cos(v);return mat3(vec3(1,0,0),vec3(0,x,-i),vec3(0,i,x));}mat3 t(float v){float i=sin(v),x=cos(v);return mat3(vec3(x,0,i),vec3(0,1,0),vec3(-i,0,x));}mat3 p(float v){float i=sin(v),x=cos(v);return mat3(vec3(x,-i,0),vec3(i,x,0),vec3(0,0,1));}float n(vec3 v,vec3 i){vec3 x=abs(v)-i;return length(max(x,0.))+min(max(x.x,max(x.y,x.z)),0.);}float p(vec3 v,float i){return length(v)-i;}float t(vec3 v,vec3 i){float x=length(v/i),f=length(v/(i*i));return x*(x-1.)/f;}float h(vec3 v,vec2 i){vec3 x=abs(v);return max(x.z-i.y,max(x.x*.866025+v.y*.5,-v.y)-i.x*.5);}float h(vec2 v,float i,float x,float z){v.x=abs(v.x);float y=sin(i),f=cos(i);return(f*v.x>y*v.y?length(v-vec2(y,f)*x):abs(length(v)-x))-z;}float h(vec2 v){vec2 i=50.*fract(v/e);return 2.*fract(i.x*i.y*(i.x+i.y))-1.;}float l(vec2 v){vec2 i=floor(v),x=fract(v),f=x*x*(3.-2.*x);float y=h(i+vec2(0,0)),m=h(i+vec2(1,0)),z=h(i+vec2(0,1)),w=h(i+vec2(1,1)),r=y,c=m-y,g=z-y,e=y-m-z+w;return r+c*f.x+g*f.y+e*f.x*f.y;}float h(vec2 v,float i,int x){float m=exp2(-i),f=1.,z=.5,r=0.;for(int e=0;e<x;e++)r+=z*l(f*v),f*=1.9,z*=m;return r;}float F(vec2 v){return fract(sin(dot(v,vec2(12.9898,78.233)))*43758.5453);}float a(vec2 v){vec2 i=floor(v),f=fract(v);f=f*f*(3.-2.*f);float x=mix(mix(F(i),F(i+vec2(1.,0.)),f.x),mix(F(i+vec2(0.,1.)),F(i+vec2(1.,1.)),f.x),f.y);return x*x;}vec4 F(vec4 v,vec4 i){if(v.w<i.w)return v;return i;}vec3 a(vec3 v,float i){float x=cos(i*v.x),f=sin(i*v.x);mat2 z=mat2(x,-f,f,x);return vec3(z*v.xy,v.z);}vec4 l(vec3 v,float i){vec3 x=vec3(0.),f=fract(v);if(f.x<.03)x=vec3(1,0,1);else if(f.z<=.03)x=vec3(0,1,1);float z=v.y-i;return vec4(x,z);}vec4 o(vec3 v){if(p(v,10)>0)return vec4(0.,0.,0.,p(v,6));float i=a(v.xz*5),f=a(v.xz*30),x=a(v.xz*50),m=t(a(v,-.03),vec3(5.,1.,1.5))-.25+.05*i+.01*f+.005*x,r=m;for(int z=-3;z<=3;z++){float y=1.9;if(z==-2||z==2)y=1.7;else if(z==-3||z==3)y=1.4;float e=h(p(1.)*t(.3)*vec3(v.x+z*1.1,v.y-y,v.z),vec2(1.,2.))+.03*a(v.xz*10);r=max(r,-e);}vec3 y=i*vec3(.5)+f*vec3(.5)+vec3(.88,.52,.07);return vec4(y,r);}vec4 d(vec3 v){if(p(v,5)>0)return vec4(0.,0.,0.,p(v,2.5));float i=a(v.xz*5),f=a(v.xz*30),x=a(v.xz*50),m=t(a(v,-.08),vec3(2.2,.8,2.1))-.25+.05*i+.01*f+.005*x,r=m;for(int z=-1;z<=1;z++){float y=h(p(.9)*t(.3)*vec3(v.x+z*1.1,v.y-1.55,v.z),vec2(1.,6.))+.03*a(v.xz*10);r=max(r,-y);}for(int z=-1;z<=1;z++){float y=h(p(1.1)*t(-.8)*vec3(v.x+z*1.1,v.y-1.55,v.z),vec2(1.,6.))+.03*a(v.xz*10);r=max(r,-y);}vec3 y=i*vec3(.5)+f*vec3(.5)+vec3(.88,.52,.07);return vec4(y,r);}vec4 u(vec3 v){vec3 i=vec3(.6*y);if(v.y-w<0)return vec4(i,z);return vec4(i,v.y-abs(h((v.xz+vec2(50.,-30.))/2,1.1,4))*2);}vec4 T(vec3 i){vec4 y=u(i),f=l(i,w),r=vec4(0.,0.,0.,z);for(int e=0;e<v;e++){vec4 m=iLeipae[e],g=d(p(iTime-m.z)*n(iTime-m.x)*(i-m.xyz)*m.w)/m.w;r=F(r,g);if(r.w<x)break;}return F(F(y,f),r);}vec3 C(vec3 v){float i=T(vec3(v.x+x,v.y,v.z)).w-T(vec3(v.x-x,v.y,v.z)).w,f=T(vec3(v.x,v.y+x,v.z)).w-T(vec3(v.x,v.y-x,v.z)).w,z=T(vec3(v.x,v.y,v.z+x)).w-T(vec3(v.x,v.y,v.z-x)).w;return normalize(vec3(i,f,z));}mat4 C(vec3 v,vec3 i,vec3 x){vec3 f=normalize(i-v),z=normalize(cross(x,f)),r=cross(f,z);return mat4(vec4(z,0.),vec4(r,0.),vec4(-f,0.),vec4(0.,0.,0.,1.));}vec3 F(float v,vec2 i,vec2 y){vec2 x=y-i/2.;float z=i.y/tan(radians(v)/2.);return normalize(vec3(x,-z));}vec4 C(vec3 v,vec3 i,float x,float y){float f=(100.-v.y)/i.y;if(f>0.)y=min(y,f);float z=0.,r=0.,e=x;vec3 c=vec3(1.);for(int w=0;w<m;w++){z=.001*e;vec3 g=v+e*i;vec4 s=T(g);float a=s.w;if(a<z){c=s.xyz;break;}e+=a*.5;if(e>=y)break;}if(e>=y)return vec4(c,-1.);return vec4(c,e);}float T(vec3 v,vec3 i,float f){float r=1.;for(float y=1.;y<z;){float m=T(i+y*v).w;if(m<x)return 0.;r=min(r,f*m/y);y+=m;}return r;}vec3 F(vec3 v,vec3 i,vec3 x,vec3 z){vec3 f=C(i);float y=dot(f,v);vec3 r=vec3(0.);if(y>0)r=clamp(c*y*T(v,i,24.),0.,1.);vec3 m=clamp(c*(.5+.5*f.y)*(.1*s),0.,1.);float e=dot(f,-v);vec3 g=vec3(0.);if(e>0)g=clamp(c*e*(.4*c),0.,1.);return clamp(z*(r+m+g),0.,1.);}vec3 C(vec3 v,float i){vec3 x=exp2(-i*.01*g);return v*x+(1.-x)*k;}vec3 a(vec3 v,vec3 i,vec3 x){vec3 f=s-.5*i.y;if(iTime>75.){float z=5000/i.y;if(z>0.&&z<100000){vec3 y=v+z*i;float r=smoothstep(.7,1.,h(vec2(-6.+y.x*.015,2.+y.z*.003),.6,4));f=mix(f,vec3(1.),r);}}float z=(2500-v.y)/i.y;if(z>0.&&z<100000){vec3 y=v+z*i;float r=smoothstep(-.1,.8,h(2e-4*y.xz+vec2(-3.,2.),.9,8));f=mix(f,vec3(1.),.4*r);}vec3 y=exp2(-abs(z)*1e-5*g);f=f*y+(1.-y)*k;float r=dot(x,i);if(r>.996){float m=i.y-x.y;if(m>-.02)f=vec3(1,1,.5);else if(m<-.025&&m>-.03)f=vec3(1,.75,.6);else if(m<-.035&&m>-.04)f=vec3(1,.65,.7);else if(m<-.045&&m>-.05)f=vec3(1,.5,.82);else if(m<-.055&&m>-.06)f=vec3(1,.5,.82);else if(m<-.065&&m>-.07)f=vec3(1,.5,.92);else if(m<-.075&&m>-.08)f=vec3(1,.5,1.);else if(m<-.085&&m>-.09)f=vec3(1,.5,1.);}if(r>.995)f=mix(f,vec3(1.,1.,.5),(r-.995)/(1-.995));return f;}void main(){vec3 v=F(r,iResolution,gl_FragCoord.xy),x=iCamera,m=iTarget;mat4 c=C(x,m,vec3(0.,1.,0.));vec3 e=(c*vec4(v,0.)).xyz;vec4 s=C(x,e,f,z);float g=s.w;vec3 w=normalize(vec3(-97.+100.*cos(y-.2),100.*sin(y-.2),-100.));if(g<0.)FragColor=vec4(a(x,e,w),1.);else{vec3 n=s.xyz,k=x+g*e,d=F(w,k,x,n);d=C(d,g);d=pow(d,vec3(1.,.92,1.));d*=vec3(1.02,.99,.9);d.z=d.z+.1;d=smoothstep(0.,1.,d);FragColor=vec4(d,1.);}if(iTime>i)FragColor=mix(FragColor,vec4(0.),(iTime-i)/5.);else if(iTime<2.)FragColor=mix(FragColor,vec4(0.),(2.-iTime)/2.);}