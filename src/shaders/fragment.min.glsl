#version 330 core
in vec4 gl_FragCoord;out vec4 FragColor;const int v=20;const float i=100.;uniform float iTime;uniform vec2 iResolution;uniform vec3 iCamera,iTarget;uniform vec4 iLeipae[v];float f=(i-iTime)/i;const int m=400;const float y=0.,z=100.,r=60.,x=1e-5,e=3.14159265,w=.3;const vec3 c=vec3(.8,1.,1.),s=vec3(.06,.03,.69);float n(vec2 v){return fract(sin(dot(v,vec2(12.9898,78.233)))*43758.5453);}float t(vec2 v){vec2 i=floor(v),f=fract(v);f=f*f*(3.-2.*f);float z=mix(mix(n(i),n(i+vec2(1.,0.)),f.x),mix(n(i+vec2(0.,1.)),n(i+vec2(1.,1.)),f.x),f.y);return z*z;}mat3 p(float v){float i=sin(v),f=cos(v);return mat3(vec3(1,0,0),vec3(0,f,-i),vec3(0,i,f));}mat3 h(float v){float i=sin(v),f=cos(v);return mat3(vec3(f,0,i),vec3(0,1,0),vec3(-i,0,f));}mat3 l(float v){float i=sin(v),f=cos(v);return mat3(vec3(f,-i,0),vec3(i,f,0),vec3(0,0,1));}float h(float v,float f){return max(v,f);}float l(float v,float f){return min(v,f);}vec4 l(vec4 v,vec4 i){if(v.w<i.w)return v;return i;}float n(float v,float i){return max(v,-i);}vec3 p(vec3 v,float i){float f=cos(i*v.x),x=sin(i*v.x);mat2 z=mat2(f,-x,x,f);return vec3(z*v.xy,v.z);}float t(vec3 v,vec3 i){vec3 f=abs(v)-i;return length(max(f,0.))+min(max(f.x,max(f.y,f.z)),0.);}float F(vec3 v,float i){return length(v)-i;}float a(vec3 v,vec3 i){float f=length(v/i),z=length(v/(i*i));return f*(f-1.)/z;}float d(vec3 v,vec2 i){vec3 f=abs(v);return max(f.z-i.y,max(f.x*.866025+v.y*.5,-v.y)-i.x*.5);}float F(vec2 v,float i,float f,float z){v.x=abs(v.x);float x=sin(i),y=cos(i);return(y*v.x>x*v.y?length(v-vec2(x,y)*f):abs(length(v)-f))-z;}float F(vec2 v){vec2 i=50.*fract(v/e);return 2.*fract(i.x*i.y*(i.x+i.y))-1.;}float a(vec2 v){vec2 i=floor(v),f=fract(v),z=f*f*(3.-2.*f);float x=F(i+vec2(0,0)),m=F(i+vec2(1,0)),y=F(i+vec2(0,1)),w=F(i+vec2(1,1)),r=x,c=m-x,e=y-x,s=x-m-y+w;return r+c*z.x+e*z.y+s*z.x*z.y;}float F(vec2 v,float i,int z){float f=exp2(-i),x=1.,m=.5,r=0.;for(int e=0;e<z;e++)r+=m*a(x*v),x*=1.9,m*=f;return r;}vec4 g(vec3 v,float i){vec3 f=vec3(0.),z=fract(v);if(z.x<.03)f=vec3(1,0,1);else if(z.z<=.03)f=vec3(0,1,1);float x=v.y-i;return vec4(f,x);}vec4 d(vec3 v){if(F(v,10)>0)return vec4(0.,0.,0.,F(v,6));float i=t(v.xz*5),f=t(v.xz*30),x=t(v.xz*50),z=a(p(v,-.03),vec3(5.,1.,1.5))-.25+.05*i+.01*f+.005*x,r=z;for(int e=-3;e<=3;e++){float m=1.9;if(e==-2||e==2)m=1.7;else if(e==-3||e==3)m=1.4;float y=d(l(1.)*h(.3)*vec3(v.x+e*1.1,v.y-m,v.z),vec2(1.,2.))+.03*t(v.xz*10);r=n(r,y);}vec3 m=i*vec3(.5)+f*vec3(.5)+vec3(.88,.52,.07);return vec4(m,r);}vec4 g(vec3 v){if(F(v,5)>0)return vec4(0.,0.,0.,F(v,2.5));float i=t(v.xz*5),f=t(v.xz*30),x=t(v.xz*50),z=a(p(v,-.08),vec3(2.2,.8,2.1))-.25+.05*i+.01*f+.005*x,r=z;for(int e=-1;e<=1;e++){float m=d(l(.9)*h(.3)*vec3(v.x+e*1.1,v.y-1.55,v.z),vec2(1.,6.))+.03*t(v.xz*10);r=n(r,m);}for(int e=-1;e<=1;e++){float m=d(l(1.1)*h(-.8)*vec3(v.x+e*1.1,v.y-1.55,v.z),vec2(1.,6.))+.03*t(v.xz*10);r=n(r,m);}vec3 m=i*vec3(.5)+f*vec3(.5)+vec3(.88,.52,.07);return vec4(m,r);}vec4 o(vec3 v){vec3 i=vec3(.6*f);if(v.y-w<0)return vec4(i,z);return vec4(i,v.y-abs(F((v.xz+vec2(50.,-30.))/2,1.1,4))*2);}vec4 u(vec3 i){vec4 f=o(i),r=g(i,w),e=vec4(0.,0.,0.,z);for(int m=0;m<v;m++){vec4 y=iLeipae[m],s=g(l(iTime-y.z)*p(iTime-y.x)*(i-y.xyz)*y.w)/y.w;e=l(e,s);if(e.w<x)break;}return l(l(f,r),e);}vec3 T(vec3 v){float i=u(vec3(v.x+x,v.y,v.z)).w-u(vec3(v.x-x,v.y,v.z)).w,f=u(vec3(v.x,v.y+x,v.z)).w-u(vec3(v.x,v.y-x,v.z)).w,z=u(vec3(v.x,v.y,v.z+x)).w-u(vec3(v.x,v.y,v.z-x)).w;return normalize(vec3(i,f,z));}mat4 T(vec3 v,vec3 i,vec3 f){vec3 x=normalize(i-v),z=normalize(cross(f,x)),r=cross(x,z);return mat4(vec4(z,0.),vec4(r,0.),vec4(-x,0.),vec4(0.,0.,0.,1.));}vec3 a(float v,vec2 i,vec2 f){vec2 x=f-i/2.;float z=i.y/tan(radians(v)/2.);return normalize(vec3(x,-z));}vec4 T(vec3 v,vec3 i,float f,float x){float z=(100.-v.y)/i.y;if(z>0.)x=min(x,z);float r=0.,e=0.,y=f;vec3 c=vec3(1.);for(int w=0;w<m;w++){r=.001*y;vec3 l=v+y*i;vec4 s=u(l);float n=s.w;if(n<r){c=s.xyz;break;}y+=n*.5;if(y>=x)break;}if(y>=x)return vec4(c,-1.);return vec4(c,y);}float T(vec3 v,vec3 i){for(float f=1.;f<z;){float m=u(i+f*v).w;if(m<x)return 0.;f+=m;}return 1.;}float d(vec3 v,vec3 i,float f){float r=1.;for(float e=1.;e<z;){float m=u(i+e*v).w;if(m<x)return 0.;r=min(r,f*m/e);e+=m;}return r;}vec3 a(vec3 v,vec3 i,vec3 f,vec3 z){vec3 x=T(i);float m=dot(x,v);vec3 r=vec3(0.);if(m>0)r=clamp(c*m*d(v,i,24.),0.,1.);vec3 e=clamp(c*(.5+.5*x.y)*(.1*s),0.,1.);float y=dot(x,-v);vec3 w=vec3(0.);if(y>0)w=clamp(c*y*(.4*c),0.,1.);return clamp(z*(r+e+w),0.,1.);}vec3 o(vec3 v,float i){vec3 f=exp2(-i*.01*vec3(2.5,1.5,1.));return v*f+(1.-f)*vec3(.94,.12,.58);}vec3 g(vec3 v,vec3 i,vec3 f){vec3 r=s-.5*i.y;if(iTime>75.){float m=5000/i.y;if(m>0.&&m<100000){vec3 e=v+m*i;float z=smoothstep(.7,1.,F(vec2(-6.+e.x*.015,2.+e.z*.003),.6,4));r=mix(r,vec3(1.),z);}}float z=(2500-v.y)/i.y;if(z>0.&&z<100000){vec3 m=v+z*i;float x=smoothstep(-.1,.8,F(2e-4*m.xz+vec2(-3.,2.),.9,8));r=mix(r,vec3(1.),.4*x);}vec3 x=exp2(-abs(z)*1e-5*vec3(2.5,1.5,1.));r=r*x+(1.-x)*vec3(.94,.12,.58);float m=dot(f,i);if(m>.996){float e=i.y-f.y;if(e>-.02)r=vec3(1,1,.5);else if(e<-.025&&e>-.03)r=vec3(1,.75,.6);else if(e<-.035&&e>-.04)r=vec3(1,.65,.7);else if(e<-.045&&e>-.05)r=vec3(1,.5,.82);else if(e<-.055&&e>-.06)r=vec3(1,.5,.82);else if(e<-.065&&e>-.07)r=vec3(1,.5,.92);else if(e<-.075&&e>-.08)r=vec3(1,.5,1.);else if(e<-.085&&e>-.09)r=vec3(1,.5,1.);}if(m>.995)r=mix(r,vec3(1.,1.,.5),(m-.995)/(1-.995));return r;}void main(){vec3 v=a(r,iResolution,gl_FragCoord.xy),x=iCamera,m=iTarget;mat4 e=T(x,m,vec3(0.,1.,0.));vec3 c=(e*vec4(v,0.)).xyz;vec4 s=T(x,c,y,z);float w=s.w;vec3 l=normalize(vec3(-97.+100.*cos(f-.2),100.*sin(f-.2),-100.));if(w<0.)FragColor=vec4(g(x,c,l),1.);else{vec3 n=s.xyz,F=x+w*c,u=a(l,F,x,n);u=o(u,w);u=pow(u,vec3(1.,.92,1.));u*=vec3(1.02,.99,.9);u.z=u.z+.1;u=smoothstep(0.,1.,u);FragColor=vec4(u,1.);}if(iTime>i)FragColor=mix(FragColor,vec4(0.),(iTime-i)/5.);else if(iTime<2.)FragColor=mix(FragColor,vec4(0.),(2.-iTime)/2.);}