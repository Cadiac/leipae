#version 330 core
in vec4 gl_FragCoord;out vec4 FragColor;const int v=20;const float i=100.;uniform float iTime,iBeat;uniform vec2 iResolution;uniform vec3 iCamera,iTarget;uniform vec4 iLeipae[v];float y=(i-iTime)/i;const int m=512;const float f=0.,z=100.,r=60.,x=1e-5,e=3.14159265,w=.3;const vec3 c=vec3(.8,1.,1.),s=vec3(.06,.03,.69);float n(vec2 v){return fract(sin(dot(v,vec2(12.9898,78.233)))*43758.5453);}float t(vec2 v){vec2 i=floor(v),f=fract(v);f=f*f*(3.-2.*f);float z=mix(mix(n(i),n(i+vec2(1.,0.)),f.x),mix(n(i+vec2(0.,1.)),n(i+vec2(1.,1.)),f.x),f.y);return z*z;}mat3 p(float v){float f=sin(v),z=cos(v);return mat3(vec3(1,0,0),vec3(0,z,-f),vec3(0,f,z));}mat3 h(float v){float f=sin(v),z=cos(v);return mat3(vec3(z,0,f),vec3(0,1,0),vec3(-f,0,z));}mat3 l(float v){float i=sin(v),f=cos(v);return mat3(vec3(f,-i,0),vec3(i,f,0),vec3(0,0,1));}float h(float v,float f){return max(v,f);}float l(float v,float f){return min(v,f);}vec4 l(vec4 v,vec4 z){if(v.w<z.w)return v;return z;}float n(float v,float i){return max(v,-i);}float h(vec3 v,float i,float z){vec2 f=vec2(i,abs(v.z)-z);return min(max(f.x,f.y),0.)+length(max(f,0.));}vec3 p(vec3 v,float i){float f=cos(i*v.y),z=sin(i*v.y);mat2 m=mat2(f,-z,z,f);return vec3(m*v.xz,v.y);}vec3 t(vec3 v,float i){float f=cos(i*v.x),z=sin(i*v.x);mat2 m=mat2(f,-z,z,f);return vec3(m*v.xy,v.z);}vec3 d(vec3 v,float f){return mod(v+.5*f,f)-.5*f;}vec3 d(vec3 v,float z,vec3 f){return v-z*clamp(round(v/z),-f,f);}float g(vec3 v,vec3 z){vec3 f=abs(v)-z;return length(max(f,0.))+min(max(f.x,max(f.y,f.z)),0.);}float F(vec3 v,float z){return length(v)-z;}float a(vec3 v,vec3 i){float f=length(v/i),z=length(v/(i*i));return f*(f-1.)/z;}float o(vec3 v,vec2 f){vec3 i=abs(v);return max(i.z-f.y,max(i.x*.866025+v.y*.5,-v.y)-f.x*.5);}float F(vec2 v,float i,float f,float z){v.x=abs(v.x);float m=sin(i),x=cos(i);return(x*v.x>m*v.y?length(v-vec2(m,x)*f):abs(length(v)-f))-z;}float F(vec2 v){vec2 f=50.*fract(v/e);return 2.*fract(f.x*f.y*(f.x+f.y))-1.;}float a(vec2 v){vec2 i=floor(v),f=fract(v),z=f*f*(3.-2.*f);float m=F(i+vec2(0,0)),s=F(i+vec2(1,0)),x=F(i+vec2(0,1)),w=F(i+vec2(1,1)),r=m,c=s-m,y=x-m,e=m-s-x+w;return r+c*z.x+y*z.y+e*z.x*z.y;}float F(vec2 v,float f,int z){float i=exp2(-f),m=1.,c=.5,r=0.;for(int e=0;e<z;e++)r+=c*a(m*v),m*=1.9,c*=i;return r;}vec4 u(vec3 v,float z){vec3 i=vec3(0.),f=fract(v);if(f.x<.03)i=vec3(1,0,1);else if(f.z<=.03)i=vec3(0,1,1);float m=v.y-z;return vec4(i,m);}vec4 d(vec3 v){if(F(v,10)>0)return vec4(0.,0.,0.,z);float f=t(v.xz*5),i=t(v.xz*30),x=t(v.xz*50),m=a(t(v,-.03),vec3(5.,1.,1.5))-.25+.05*f+.01*i+.005*x,r=m;for(int e=-3;e<=3;e++){float y=1.9;if(e==-2||e==2)y=1.7;else if(e==-3||e==3)y=1.4;float c=o(l(1.)*h(.3)*vec3(v.x+e*1.1,v.y-y,v.z),vec2(1.,2.))+.03*t(v.xz*10);r=n(r,c);}vec3 y=f*vec3(.5)+i*vec3(.5)+vec3(.88,.52,.07);return vec4(y,r);}vec4 g(vec3 v){if(F(v,10)>0)return vec4(0.,0.,0.,z);float f=t(v.xz*5),i=t(v.xz*30),x=t(v.xz*50),m=a(t(v,-.08),vec3(2.2,.8,2.1))-.25+.05*f+.01*i+.005*x,r=m;for(int e=-1;e<=1;e++){float y=o(l(.9)*h(.3)*vec3(v.x+e*1.1,v.y-1.55,v.z),vec2(1.,6.))+.03*t(v.xz*10);r=n(r,y);}for(int e=-1;e<=1;e++){float y=o(l(1.1)*h(-.8)*vec3(v.x+e*1.1,v.y-1.55,v.z),vec2(1.,6.))+.03*t(v.xz*10);r=n(r,y);}vec3 y=f*vec3(.5)+i*vec3(.5)+vec3(.88,.52,.07);return vec4(y,r);}vec4 o(vec3 v){vec3 i=vec3(.5*y);if(v.y-w<0)return vec4(i,z);return vec4(i,v.y-abs(F((v.xz+vec2(50.,-30.))/2,1.1-iBeat,4))*2);}vec4 u(vec3 i){vec4 f=o(i),y=u(i,w),r=vec4(0.,0.,0.,z);for(int e=0;e<v;e++){vec4 m=iLeipae[e],c=g(l(iTime-m.z)*p(iTime-m.x)*(i-m.xyz)*m.w)/m.w;r=l(r,c);if(r.w<x)break;}return l(l(f,r),y);}vec3 T(vec3 v){float i=u(vec3(v.x+x,v.y,v.z)).w-u(vec3(v.x-x,v.y,v.z)).w,f=u(vec3(v.x,v.y+x,v.z)).w-u(vec3(v.x,v.y-x,v.z)).w,z=u(vec3(v.x,v.y,v.z+x)).w-u(vec3(v.x,v.y,v.z-x)).w;return normalize(vec3(i,f,z));}mat4 T(vec3 v,vec3 i,vec3 f){vec3 z=normalize(i-v),y=normalize(cross(f,z)),r=cross(z,y);return mat4(vec4(y,0.),vec4(r,0.),vec4(-z,0.),vec4(0.,0.,0.,1.));}vec3 a(float v,vec2 f,vec2 i){vec2 m=i-f/2.;float z=f.y/tan(radians(v)/2.);return normalize(vec3(m,-z));}vec4 T(vec3 v,vec3 f,float i,float z){float y=(100.-v.y)/f.y;if(y>0.)z=min(z,y);float r=0.,e=0.,x=i;vec3 c=vec3(1.);for(int w=0;w<m;w++){r=.001*x;vec3 l=v+x*f;vec4 s=u(l);float n=s.w;if(n<r){c=s.xyz;break;}x+=n*.5;if(x>=z)break;}if(x>=z)return vec4(c,-1.);return vec4(c,x);}float T(vec3 v,vec3 i){for(float f=1.;f<z;){float m=u(i+f*v).w;if(m<x)return 0.;f+=m;}return 1.;}float g(vec3 v,vec3 i,float f){float r=1.;for(float e=1.;e<z;){float m=u(i+e*v).w;if(m<x)return 0.;r=min(r,f*m/e);e+=m;}return r;}vec3 a(vec3 v,vec3 f,vec3 i,vec3 z){vec3 m=T(f);float r=dot(m,v);vec3 y=vec3(0.);if(r>0)y=clamp(c*r*g(v,f,24.),0.,1.);vec3 e=clamp(c*(.5+.5*m.y)*(.1*s),0.,1.);float x=dot(m,-v);vec3 w=vec3(0.);if(x>0)w=clamp(c*x*(.4*c),0.,1.);return clamp(z*(y+e+w),0.,1.);}vec3 C(vec3 v,float z){vec3 f=exp2(-z*.01*vec3(1.,2.,3.5));return v*f+(1.-f)*vec3(.94,.12,.58);}vec3 C(vec3 v,vec3 f,vec3 i){vec3 r=s-.5*f.y;if(iTime>75.){float m=5000/f.y;if(m>0.&&m<100000){vec3 z=v+m*f;float y=smoothstep(.93,1.,F(z.xz*.003,.6,4));r=mix(r,vec3(1.),y);}}float z=(2500-v.y)/f.y;if(z>0.&&z<100000){vec3 m=v+z*f;float y=smoothstep(-.1,.8,F(2e-4*m.xz+vec2(-3.,2.),.9,8));r=mix(r,vec3(1.),.4*y);}vec3 y=exp2(-abs(z)*1e-5*vec3(1.,2.,3.5));r=r*y+(1.-y)*vec3(.94,.12,.58);float m=dot(i,f);if(m>.996){float e=f.y-i.y;if(e>-.02)r=vec3(1,1,.5);else if(e<-.025&&e>-.03)r=vec3(1,.75,.6);else if(e<-.035&&e>-.04)r=vec3(1,.65,.7);else if(e<-.045&&e>-.05)r=vec3(1,.5,.82);else if(e<-.055&&e>-.06)r=vec3(1,.5,.82);else if(e<-.065&&e>-.07)r=vec3(1,.5,.92);else if(e<-.075&&e>-.08)r=vec3(1,.5,1.);else if(e<-.085&&e>-.09)r=vec3(1,.5,1.);}if(m>.995)r=mix(r,vec3(1.,1.,.5),(m-.995)/(1-.995));return r;}void main(){vec3 v=a(r,iResolution,gl_FragCoord.xy),m=iCamera,x=iTarget;mat4 e=T(m,x,vec3(0.,1.,0.));vec3 c=(e*vec4(v,0.)).xyz;vec4 s=T(m,c,f,z);float w=s.w;vec3 l=normalize(vec3(-97.+100.*cos(y-.2),100.*sin(y-.2),-100.));if(w<0.)FragColor=vec4(C(m,c,l),1.);else{vec3 n=s.xyz,t=m+w*c,d=a(l,t,m,n);d=C(d,w);d=pow(d,vec3(1.,.92,1.));d*=vec3(1.02,.99,.9);d.z=d.z+.1;d=smoothstep(0.,1.,d);FragColor=vec4(d,1.);}if(iTime>i)FragColor=mix(FragColor,vec4(0.),(iTime-i)/5.);else if(iTime<2.)FragColor=mix(FragColor,vec4(0.),(2.-iTime)/2.);}